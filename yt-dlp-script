# --- Instalador Automático de yt-dlp & ffmpeg para Windows ---
# --- @mehsaiah ---

# --- INÍCIO DO SCRIPT DE INSTALAÇÃO ---

# 1. DEFINIR CAMINHO DE INSTALAÇÃO E ADICIONAR AO AMBIENTE
$InstallPath = Join-Path $HOME "yt-dlp"
if (-not (Test-Path -Path $InstallPath)) {
    Write-Host "`nCriando diretório de instalação em: $InstallPath"
    New-Item -ItemType Directory -Path $InstallPath
}

$CurrentUserPath = [System.Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::User)
if ($CurrentUserPath -notlike "*$InstallPath*") {
    Write-Host "Adicionando '$InstallPath' ao seu PATH de usuário."
    $NewPath = "$CurrentUserPath;$InstallPath"
    [System.Environment]::SetEnvironmentVariable('Path', $NewPath, [System.EnvironmentVariableTarget]::User)
} else {
    Write-Host "`n✅ Seu PATH já inclui o diretório de destino."
}

# 2. INSTALAR YT-DLP
Write-Host "`n--- Instalando yt-dlp ---"
$YtDlpUrl = "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe"
$YtDlpExePath = Join-Path $InstallPath "yt-dlp.exe"
try {
    $job = Start-BitsTransfer -Source $YtDlpUrl -Destination $YtDlpExePath -DisplayName "Baixando yt-dlp.exe" -Asynchronous
    while ($job.JobState -in ('Connecting', 'Transferring')) {
        $progress = ($job.BytesTransferred / $job.BytesTotal) * 100
        $downloadedMB = [math]::Round($job.BytesTransferred / 1MB, 2)
        $totalMB = [math]::Round($job.BytesTotal / 1MB, 2)
        Write-Progress -Activity "Baixando yt-dlp.exe" -Status "$downloadedMB MB / $totalMB MB" -PercentComplete $progress
        Start-Sleep -Milliseconds 200
    }
    Write-Progress -Activity "Baixando yt-dlp.exe" -Completed
    Complete-BitsTransfer -BitsJob $job
    Write-Host "`n✅ Download do yt-dlp concluído com sucesso."
} catch {
    Write-Host "`n❌ Falha ao baixar o yt-dlp. Verifique sua conexão e tente novamente." -ForegroundColor Red
    return
}

# 3. INSTALAR FFMPEG
Write-Host "`n--- Instalando ffmpeg ---"
$FfmpegZipUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-win64-gpl.zip"
$TempZipFile = Join-Path $env:TEMP "ffmpeg.zip"
$TempExtractPath = Join-Path $env:TEMP "ffmpeg-extraido"
try {
    $job = Start-BitsTransfer -Source $FfmpegZipUrl -Destination $TempZipFile -DisplayName "Baixando ffmpeg.zip" -Asynchronous
    while ($job.JobState -in ('Connecting', 'Transferring')) {
        $progress = ($job.BytesTransferred / $job.BytesTotal) * 100
        $downloadedMB = [math]::Round($job.BytesTransferred / 1MB, 2)
        $totalMB = [math]::Round($job.BytesTotal / 1MB, 2)
        Write-Progress -Activity "Baixando ffmpeg.zip" -Status "$downloadedMB MB / $totalMB MB" -PercentComplete $progress
        Start-Sleep -Milliseconds 200
    }
    Write-Progress -Activity "Baixando ffmpeg.zip" -Completed
    Complete-BitsTransfer -BitsJob $job

    Write-Host "`nExtraindo arquivos..."
    Expand-Archive -Path $TempZipFile -DestinationPath $TempExtractPath -Force
    $BinDir = Get-ChildItem -Path $TempExtractPath -Directory | Select-Object -First 1
    Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffmpeg.exe") -Destination $InstallPath
    Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffprobe.exe") -Destination $InstallPath
    Write-Host "✅ ffmpeg instalado com sucesso."
} catch {
    Write-Host "`n❌ Falha ao instalar o ffmpeg. Verifique sua conexão e tente novamente." -ForegroundColor Red
} finally {
    Write-Host "Limpando arquivos temporários..."
    if (Test-Path -Path $TempZipFile) { Remove-Item $TempZipFile -Force }
    if (Test-Path -Path $TempExtractPath) { Remove-Item $TempExtractPath -Recurse -Force }
}

# 4. CRIAR ARQUIVO DE CONFIGURAÇÃO (yt-dlp.conf)
Write-Host "`n--- Criando arquivo de configuração padrão ---"
$ConfigContent = @"
# ======================================================
# ARQUIVO DE CONFIGURAÇÃO PADRÃO PARA YT-DLP
# ======================================================
-P "~/Documents/yt-dlp"
-f "bv[vcodec^=hvc1][height>1080]+ba / bv[vcodec^=avc1][height<=1080]+ba / bv*+ba / b"
--remux-video mp4
"@
$ConfPath = Join-Path $InstallPath "yt-dlp.conf"
try {
    Set-Content -Path $ConfPath -Value $ConfigContent
    Write-Host "✅ Arquivo de configuração (yt-dlp.conf) criado com sucesso."
} catch {
    Write-Host "❌ Falha ao criar o arquivo de configuração." -ForegroundColor Red
}

# 5. INSTRUÇÕES FINAIS
Write-Host "`n🎉 Instalação e configuração concluídas!" -ForegroundColor Green
Write-Host "Script por @mehsaiah" -ForegroundColor DarkGray
Write-Host "IMPORTANTE: Você deve REINICIAR seu terminal para que as alterações tenham efeito." -ForegroundColor Yellow
