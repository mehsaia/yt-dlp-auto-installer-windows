# --- Instalador AutomÃ¡tico de yt-dlp & ffmpeg para Windows ---
# --- @mehsaiah ---

# --- FUNÃ‡ÃƒO DE DOWNLOAD COM BARRA DE PROGRESSO ASCII ---
function Start-DownloadWithCoolBar {
    param(
        [Parameter(Mandatory=$true)] [string]$Uri,
        [Parameter(Mandatory=$true)] [string]$OutFile,
        [Parameter(Mandatory=$true)] [string]$Title
    )
    
    Write-Host "  $Title"
    $job = Start-BitsTransfer -Source $Uri -Destination $OutFile -Asynchronous
    
    while ($job.JobState -in ('Connecting', 'Transferring')) {
        if ($job.BytesTotal -gt 0) {
            $percent = [int](($job.BytesTransferred / $job.BytesTotal) * 100)
            $downloadedMB = [math]::Round($job.BytesTransferred / 1MB, 2)
            $totalMB = [math]::Round($job.BytesTotal / 1MB, 2)
            
            # Define o tamanho da barra de progresso
            $barWidth = 40
            $filledBlocks = [int](($percent / 100) * $barWidth)
            $emptyBlocks = $barWidth - $filledBlocks
            
            # Cria a string da barra
            $bar = "â–ˆ" * $filledBlocks + "â–‘" * $emptyBlocks
            
            # Monta a linha de status completa
            $status = "  [$bar] $percent %  ($downloadedMB MB / $totalMB MB)"
            
            # Usa o carriage return `r para sobrescrever a linha
            Write-Host -NoNewline "`r$status"
        }
        Start-Sleep -Milliseconds 100
    }
    
    # Limpa a linha da barra de progresso e mostra a mensagem de sucesso
    Write-Host "`r" + (" " * 80) + "`r"
    Complete-BitsTransfer -BitsJob $job
    Write-Host "  âœ… Download concluÃ­do com sucesso."
}

# --- INÃCIO DO SCRIPT DE INSTALAÃ‡ÃƒO ---

Clear-Host
Write-Host "============================================================" -ForegroundColor Green
Write-Host "   Bem-vindo ao Instalador AutomÃ¡tico para yt-dlp" -ForegroundColor White
Write-Host "   Script por @mehsaiah" -ForegroundColor Cyan
Write-Host "============================================================" -ForegroundColor Green
Write-Host "`nEste script irÃ¡ baixar e configurar o yt-dlp e o ffmpeg para vocÃª."
Start-Sleep -Seconds 2

# --- PASSO 1: Configurando o Ambiente ---
Write-Host "`n--- [ PASSO 1 de 4 ] Configurando o Ambiente ---" -ForegroundColor Yellow
try {
    $InstallPath = Join-Path $HOME "yt-dlp"
    if (-not (Test-Path -Path $InstallPath)) {
        New-Item -ItemType Directory -Path $InstallPath
        Write-Host "  âœ… DiretÃ³rio de instalaÃ§Ã£o criado em: $InstallPath"
    } else {
        Write-Host "  âœ… DiretÃ³rio de instalaÃ§Ã£o jÃ¡ existe."
    }

    $CurrentUserPath = [System.Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::User)
    if ($CurrentUserPath -notlike "*$InstallPath*") {
        $NewPath = "$CurrentUserPath;$InstallPath"
        [System.Environment]::SetEnvironmentVariable('Path', $NewPath, [System.EnvironmentVariableTarget]::User)
        Write-Host "  âœ… DiretÃ³rio adicionado ao PATH do Windows com sucesso."
    } else {
        Write-Host "  âœ… DiretÃ³rio jÃ¡ configurado no PATH do Windows."
    }
} catch {
    Write-Host "  âŒ Erro ao configurar o ambiente." -ForegroundColor Red; return
}

# --- PASSO 2: Instalando yt-dlp ---
Write-Host "`n--- [ PASSO 2 de 4 ] Baixando yt-dlp ---" -ForegroundColor Yellow
try {
    $YtDlpUrl = "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe"
    $YtDlpExePath = Join-Path $InstallPath "yt-dlp.exe"
    Start-DownloadWithCoolBar -Uri $YtDlpUrl -OutFile $YtDlpExePath -Title "Baixando yt-dlp.exe..."
} catch {
    Write-Host "`n  âŒ Falha ao baixar o yt-dlp. Verifique sua conexÃ£o e tente novamente." -ForegroundColor Red; return
}

# --- PASSO 3: Instalando ffmpeg ---
Write-Host "`n--- [ PASSO 3 de 4 ] Baixando e Instalando ffmpeg ---" -ForegroundColor Yellow
$TempZipFile = Join-Path $env:TEMP "ffmpeg.zip"
$TempExtractPath = Join-Path $env:TEMP "ffmpeg-extraido"
try {
    $FfmpegZipUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-win64-gpl.zip"
    Start-DownloadWithCoolBar -Uri $FfmpegZipUrl -OutFile $TempZipFile -Title "Baixando ffmpeg.zip (arquivo grande)..."
    
    Write-Host "  Descompactando arquivos..."
    Expand-Archive -Path $TempZipFile -DestinationPath $TempExtractPath -Force
    
    $BinDir = Get-ChildItem -Path $TempExtractPath -Directory | Select-Object -First 1
    Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffmpeg.exe") -Destination $InstallPath
    Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffprobe.exe") -Destination $InstallPath
    Write-Host "  âœ… ffmpeg instalado com sucesso."
} catch {
    Write-Host "`n  âŒ Falha ao instalar o ffmpeg." -ForegroundColor Red
} finally {
    Write-Host "  Limpando arquivos temporÃ¡rios..."
    if (Test-Path -Path $TempZipFile) { Remove-Item $TempZipFile -Force }
    if (Test-Path -Path $TempExtractPath) { Remove-Item $TempExtractPath -Recurse -Force }
}

# --- PASSO 4: Criando Arquivo de ConfiguraÃ§Ã£o ---
Write-Host "`n--- [ PASSO 4 de 4 ] Criando Arquivo de ConfiguraÃ§Ã£o ---" -ForegroundColor Yellow
try {
    $ConfigContent = @"
# ConfiguraÃ§Ã£o PadrÃ£o para yt-dlp por @mehsaiah
-P "~/Documents/yt-dlp"
-f "bv[vcodec^=hvc1][height>1080]+ba / bv[vcodec^=avc1][height<=1080]+ba / bv*+ba / b"
--remux-video mp4
"@
    $ConfPath = Join-Path $InstallPath "yt-dlp.conf"
    Set-Content -Path $ConfPath -Value $ConfigContent
    Write-Host "  âœ… Arquivo de configuraÃ§Ã£o 'yt-dlp.conf' criado."
} catch {
    Write-Host "  âŒ Falha ao criar o arquivo de configuraÃ§Ã£o." -ForegroundColor Red
}

# --- Mensagem Final ---
Write-Host "`n============================================================" -ForegroundColor Green
Write-Host "   ðŸŽ‰ InstalaÃ§Ã£o e ConfiguraÃ§Ã£o ConcluÃ­das! ðŸŽ‰" -ForegroundColor White
Write-Host "============================================================" -ForegroundColor Green
Write-Host "\nIMPORTANTE: VocÃª deve REINICIAR seu terminal (PowerShell, CMD, etc.)" -ForegroundColor Yellow
Write-Host "para que as alteraÃ§Ãµes tenham efeito." -ForegroundColor Yellow
