# --- Instalador Autom√°tico de yt-dlp & ffmpeg para Windows ---
# --- @mehsaiah ---

# --- IN√çCIO DO SCRIPT ---

# 1. DEFINIR CAMINHO DE INSTALA√á√ÉO E ADICIONAR AO AMBIENTE
$InstallPath = Join-Path $HOME "yt-dlp"
if (-not (Test-Path -Path $InstallPath)) {
    Write-Host "`nCriando diret√≥rio de instala√ß√£o em: $InstallPath"
    New-Item -ItemType Directory -Path $InstallPath
}

$CurrentUserPath = [System.Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::User)
if ($CurrentUserPath -notlike "*$InstallPath*") {
    Write-Host "Adicionando '$InstallPath' ao seu PATH de usu√°rio."
    $NewPath = "$CurrentUserPath;$InstallPath"
    [System.Environment]::SetEnvironmentVariable('Path', $NewPath, [System.EnvironmentVariableTarget]::User)
} else {
    Write-Host "`n‚úÖ Seu PATH j√° inclui o diret√≥rio de destino."
}

# 2. INSTALAR YT-DLP
Write-Host "`n--- Instalando yt-dlp ---"
$YtDlpUrl = "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe"
$YtDlpExePath = Join-Path $InstallPath "yt-dlp.exe"
try {
    Invoke-WebRequest -Uri $YtDlpUrl -OutFile $YtDlpExePath -UseBasicParsing
    Write-Host "‚úÖ Download do yt-dlp conclu√≠do com sucesso."
} catch {
    Write-Host "‚ùå Falha ao baixar o yt-dlp. Verifique sua conex√£o com a internet e tente novamente." -ForegroundColor Red
    return
}

# 3. INSTALAR FFMPEG
Write-Host "`n--- Instalando ffmpeg ---"
# Usando as compila√ß√µes confi√°veis do BtbN em formato .zip para extra√ß√£o f√°cil
$FfmpegZipUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-win64-gpl.zip"
$TempZipFile = Join-Path $env:TEMP "ffmpeg.zip"
$TempExtractPath = Join-Path $env:TEMP "ffmpeg-extraido"

try {
    Write-Host "Baixando ffmpeg.zip (isso pode levar um momento)..."
    Invoke-WebRequest -Uri $FfmpegZipUrl -OutFile $TempZipFile -UseBasicParsing
    Write-Host "Extraindo arquivos..."
    Expand-Archive -Path $TempZipFile -DestinationPath $TempExtractPath -Force
    $BinDir = Get-ChildItem -Path $TempExtractPath -Directory | Select-Object -First 1
    Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffmpeg.exe") -Destination $InstallPath
    Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffprobe.exe") -Destination $InstallPath
    Write-Host "‚úÖ ffmpeg instalado com sucesso."
} catch {
    Write-Host "‚ùå Falha ao instalar o ffmpeg. Erro: $($_.Exception.Message)" -ForegroundColor Red
} finally {
    # Limpeza de arquivos tempor√°rios
    Write-Host "Limpando arquivos tempor√°rios..."
    if (Test-Path -Path $TempZipFile) { Remove-Item $TempZipFile -Force }
    if (Test-Path -Path $TempExtractPath) { Remove-Item $TempExtractPath -Recurse -Force }
}

# 4. CRIAR ARQUIVO DE CONFIGURA√á√ÉO (yt-dlp.conf)
Write-Host "`n--- Criando arquivo de configura√ß√£o padr√£o ---"
$ConfigContent = @"
# ======================================================
# ARQUIVO DE CONFIGURA√á√ÉO PADR√ÉO PARA YT-DLP
# ======================================================

# --- DESTINO ---
# Salva todos os arquivos na pasta 'yt-dlp' dentro de Documentos.
-P "~/Documents/yt-dlp"

# --- SELE√á√ÉO DE FORMATO ---
# Seleciona o melhor codec de v√≠deo com base na resolu√ß√£o e o melhor √°udio.
# 1. Para v√≠deos > 1080p, prefere H.265/HEVC.
# 2. Para v√≠deos <= 1080p, prefere H.264/AVC.
# 3. Se os codecs espec√≠ficos n√£o forem encontrados, baixa a melhor qualidade dispon√≠vel.
-f "bv*[vcodec~=^h265][height>1080]+ba / bv*[vcodec~=^h264][height<=1080]+ba / bv*+ba / b"

# --- FORMATO DE SA√çDA ---
# Sempre salva o arquivo final como .mp4 para m√°xima compatibilidade.
--remux-video mp4

# --- QUALIDADE DE √ÅUDIO ---
# A sele√ß√£o padr√£o 'ba' (bestaudio) geralmente resulta em Opus ou AAC de alta qualidade.
# Para obter √°udio sem perdas (lossless) em formato FLAC (arquivos maiores),
# remova o '#' da linha abaixo.
# -x --audio-format flac
"@

$ConfPath = Join-Path $InstallPath "yt-dlp.conf"
try {
    Set-Content -Path $ConfPath -Value $ConfigContent
    Write-Host "‚úÖ Arquivo de configura√ß√£o (yt-dlp.conf) criado com sucesso."
    Write-Host "   - Os v√≠deos ser√£o salvos em: Documentos\yt-dlp" -ForegroundColor Green
    Write-Host "   - Formato padr√£o: MP4 (H.265 para >1080p, H.264 para <=1080p) com o melhor √°udio." -ForegroundColor Green
} catch {
    Write-Host "‚ùå Falha ao criar o arquivo de configura√ß√£o." -ForegroundColor Red
}


# 5. INSTRU√á√ïES FINAIS
Write-Host "`nüéâ Instala√ß√£o e configura√ß√£o conclu√≠das!" -ForegroundColor Green
Write-Host "Script por @mehsaiah" -ForegroundColor DarkGray
Write-Host "IMPORTANTE: Voc√™ deve REINICIAR seu terminal (PowerShell, CMD, etc.) para que as altera√ß√µes tenham efeito." -ForegroundColor Yellow
Write-Host "Ap√≥s reiniciar, apenas 'yt-dlp URL' usar√° automaticamente suas novas configura√ß√µes."
