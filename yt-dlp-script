# --- Instalador Autom√°tico de yt-dlp & ffmpeg para Windows ---
# --- @mehsaiah ---

# --- IN√çCIO DO SCRIPT ---

# 1. DEFINIR CAMINHO DE INSTALA√á√ÉO E ADICIONAR AO AMBIENTE
$InstallPath = Join-Path $HOME "yt-dlp"
if (-not (Test-Path -Path $InstallPath)) {
    Write-Host "`nCriando diret√≥rio de instala√ß√£o em: $InstallPath"
    New-Item -ItemType Directory -Path $InstallPath
}

$CurrentUserPath = [System.Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::User)
if ($CurrentUserPath -notlike "*$InstallPath*") {
    Write-Host "Adicionando '$InstallPath' ao seu PATH de usu√°rio."
    $NewPath = "$CurrentUserPath;$InstallPath"
    [System.Environment]::SetEnvironmentVariable('Path', $NewPath, [System.EnvironmentVariableTarget]::User)
} else {
    Write-Host "`n‚úÖ Seu PATH j√° inclui o diret√≥rio de destino."
}

# 2. INSTALAR YT-DLP
Write-Host "`n--- Instalando yt-dlp ---"
$YtDlpUrl = "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe"
$YtDlpExePath = Join-Path $InstallPath "yt-dlp.exe"
try {
    Invoke-WebRequest -Uri $YtDlpUrl -OutFile $YtDlpExePath -UseBasicParsing
    Write-Host "‚úÖ Download do yt-dlp conclu√≠do com sucesso."
} catch {
    Write-Host "‚ùå Falha ao baixar o yt-dlp. Verifique sua conex√£o com a internet e tente novamente." -ForegroundColor Red
    return
}

# 3. INSTALAR FFMPEG
Write-Host "`n--- Instalando ffmpeg ---"
# Usando as compila√ß√µes confi√°veis do BtbN em formato .zip para extra√ß√£o f√°cil
$FfmpegZipUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-win64-gpl.zip"
$TempZipFile = Join-Path $env:TEMP "ffmpeg.zip"
$TempExtractPath = Join-Path $env:TEMP "ffmpeg-extraido"

try {
    # Download
    Write-Host "Baixando ffmpeg.zip (isso pode levar um momento)..."
    Invoke-WebRequest -Uri $FfmpegZipUrl -OutFile $TempZipFile -UseBasicParsing
    
    # Extra√ß√£o
    Write-Host "Extraindo arquivos..."
    Expand-Archive -Path $TempZipFile -DestinationPath $TempExtractPath -Force
    
    # Encontrar o diret√≥rio 'bin' e copiar os execut√°veis
    $BinDir = Get-ChildItem -Path $TempExtractPath -Directory | Select-Object -First 1
    Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffmpeg.exe") -Destination $InstallPath
    Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffprobe.exe") -Destination $InstallPath

    Write-Host "‚úÖ ffmpeg instalado com sucesso."
    
} catch {
    Write-Host "‚ùå Falha ao instalar o ffmpeg. Erro: $($_.Exception.Message)" -ForegroundColor Red
} finally {
    # Limpeza de arquivos tempor√°rios
    Write-Host "Limpando arquivos tempor√°rios..."
    if (Test-Path -Path $TempZipFile) { Remove-Item $TempZipFile -Force }
    if (Test-Path -Path $TempExtractPath) { Remove-Item $TempExtractPath -Recurse -Force }
}

# 4. INSTRU√á√ïES FINAIS
Write-Host "`nüéâ Instala√ß√£o do yt-dlp e ffmpeg conclu√≠da!" -ForegroundColor Green
Write-Host "Script por @mehsaiah" -ForegroundColor DarkGray
Write-Host "IMPORTANTE: Voc√™ deve REINICIAR seu terminal (PowerShell, CMD, etc.) para que as altera√ß√µes tenham efeito." -ForegroundColor Yellow
Write-Host "Ap√≥s reiniciar, voc√™ poder√° executar 'yt-dlp' e 'ffmpeg' de qualquer linha de comando."
