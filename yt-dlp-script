# --- Instalador Autom√°tico de yt-dlp & ffmpeg para Windows ---
# --- @mehsaiah ---

# --- FUN√á√ÉO DE DOWNLOAD COM BARRA DE PROGRESSO ASCII ---
function Start-DownloadWithCoolBar {
    param(
        [Parameter(Mandatory=$true)] [string]$Uri,
        [Parameter(Mandatory=$true)] [string]$OutFile,
        [Parameter(Mandatory=$true)] [string]$Title
    )
    
    Write-Host "  $Title"
    $job = Start-BitsTransfer -Source $Uri -Destination $OutFile -Asynchronous
    
    while ($job.JobState -in ('Connecting', 'Transferring')) {
        if ($job.BytesTotal -gt 0) {
            $percent = [int](($job.BytesTransferred / $job.BytesTotal) * 100)
            $downloadedMB = [math]::Round($job.BytesTransferred / 1MB, 2)
            $totalMB = [math]::Round($job.BytesTotal / 1MB, 2)
            
            $barWidth = 40
            $filledBlocks = [int](($percent / 100) * $barWidth)
            $emptyBlocks = $barWidth - $filledBlocks
            
            $bar = "‚ñà" * $filledBlocks + "‚ñë" * $emptyBlocks
            $status = "  [$bar] $percent %  ($downloadedMB MB / $totalMB MB)"
            
            Write-Host -NoNewline "`r$status"
        }
        Start-Sleep -Milliseconds 100
    }
    
    Write-Host "`r" + (" " * 80) + "`r"
    Complete-BitsTransfer -BitsJob $job
    Start-Sleep -Milliseconds 500 # Pequeno atraso para garantir que o arquivo seja liberado
    Write-Host "  ‚úÖ Download conclu√≠do com sucesso."
}

# --- IN√çCIO DO SCRIPT DE INSTALA√á√ÉO ---

Clear-Host
Write-Host "============================================================" -ForegroundColor Green
Write-Host "   Bem-vindo ao Instalador Autom√°tico para yt-dlp" -ForegroundColor White
Write-Host "   Script por @mehsaiah" -ForegroundColor Cyan
Write-Host "============================================================" -ForegroundColor Green
Write-Host "`nEste script ir√° baixar e configurar o yt-dlp e o ffmpeg para voc√™."
Start-Sleep -Seconds 2

# --- PASSO 1: Configurando o Ambiente ---
Write-Host "`n--- [ PASSO 1 de 4 ] Configurando o Ambiente ---" -ForegroundColor Yellow
try {
    $InstallPath = Join-Path $HOME "yt-dlp"
    if (-not (Test-Path -Path $InstallPath)) {
        New-Item -ItemType Directory -Path $InstallPath
        Write-Host "  ‚úÖ Diret√≥rio de instala√ß√£o criado em: $InstallPath"
    } else {
        Write-Host "  ‚úÖ Diret√≥rio de instala√ß√£o j√° existe."
    }
    $CurrentUserPath = [System.Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::User)
    if ($CurrentUserPath -notlike "*$InstallPath*") {
        $NewPath = "$CurrentUserPath;$InstallPath"
        [System.Environment]::SetEnvironmentVariable('Path', $NewPath, [System.EnvironmentVariableTarget]::User)
        Write-Host "  ‚úÖ Diret√≥rio adicionado ao PATH do Windows com sucesso."
    } else {
        Write-Host "  ‚úÖ Diret√≥rio j√° configurado no PATH do Windows."
    }
} catch {
    Write-Host "  ‚ùå Erro ao configurar o ambiente." -ForegroundColor Red; return
}

# --- PASSO 2: Instalando yt-dlp ---
Write-Host "`n--- [ PASSO 2 de 4 ] Baixando yt-dlp ---" -ForegroundColor Yellow
try {
    $YtDlpUrl = "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe"
    $YtDlpExePath = Join-Path $InstallPath "yt-dlp.exe"
    Start-DownloadWithCoolBar -Uri $YtDlpUrl -OutFile $YtDlpExePath -Title "Baixando yt-dlp.exe..."
    if (-not (Test-Path $YtDlpExePath)) { throw "O download do yt-dlp.exe falhou." }
} catch {
    Write-Host "`n  ‚ùå Falha ao baixar o yt-dlp. Erro: $($_.Exception.Message)" -ForegroundColor Red; return
}

# --- PASSO 3: Instalando ffmpeg com Retentativas ---
Write-Host "`n--- [ PASSO 3 de 4 ] Baixando e Instalando ffmpeg ---" -ForegroundColor Yellow
$TempZipFile = Join-Path $env:TEMP "ffmpeg.zip"
$TempExtractPath = Join-Path $env:TEMP "ffmpeg-extraido"
$maxRetries = 3
$downloadSuccess = $false

for ($retry = 1; $retry -le $maxRetries; $retry++) {
    try {
        if ($retry -gt 1) {
            Write-Host "`n  ‚ö†Ô∏è  Download falhou. Tentando novamente ($retry/$maxRetries)..." -ForegroundColor Yellow
            Start-Sleep -Seconds 5
        }
        $FfmpegZipUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-win64-gpl.zip"
        Start-DownloadWithCoolBar -Uri $FfmpegZipUrl -OutFile $TempZipFile -Title "Baixando ffmpeg.zip (arquivo grande)..."
        if (Test-Path $TempZipFile) {
            $downloadSuccess = $true
            break # Sai do loop se o download for bem-sucedido
        }
    } catch {
        # CORRE√á√ÉO: Constr√≥i a string de erro de forma segura antes de exibi-la.
        $errorMessage = "`n  (Erro na tentativa {0}: {1})" -f $retry, $_.Exception.Message
        Write-Host $errorMessage -ForegroundColor Gray
    }
}

if ($downloadSuccess) {
    try {
        Write-Host "  Descompactando arquivos..."
        Expand-Archive -Path $TempZipFile -DestinationPath $TempExtractPath -Force
        $BinDir = Get-ChildItem -Path $TempExtractPath -Directory | Select-Object -First 1
        Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffmpeg.exe") -Destination $InstallPath
        Copy-Item -Path (Join-Path $BinDir.FullName "bin\ffprobe.exe") -Destination $InstallPath
        Write-Host "  ‚úÖ ffmpeg instalado com sucesso."
    } catch {
        Write-Host "`n  ‚ùå Falha ao descompactar ou copiar o ffmpeg. Erro: $($_.Exception.Message)" -ForegroundColor Red
    }
} else {
    Write-Host "`n  ‚ùå Falha ao baixar o ffmpeg ap√≥s $maxRetries tentativas. Verifique sua conex√£o com a internet." -ForegroundColor Red
}

# Limpeza final dos arquivos tempor√°rios
if (Test-Path -Path $TempZipFile) { Remove-Item $TempZipFile -Force }
if (Test-Path -Path $TempExtractPath) { Remove-Item $TempExtractPath -Recurse -Force }


# --- PASSO 4: Criando Arquivo de Configura√ß√£o ---
Write-Host "`n--- [ PASSO 4 de 4 ] Criando Arquivo de Configura√ß√£o ---" -ForegroundColor Yellow
try {
    $ConfigContent = @"
# Configura√ß√£o Padr√£o para yt-dlp por @mehsaiah
-P "~/Documents/yt-dlp"
-f "bv*+ba/b"
--recode-video mp4
"@
    $ConfPath = Join-Path $InstallPath "yt-dlp.conf"
    Set-Content -Path $ConfPath -Value $ConfigContent
    Write-Host "  ‚úÖ Arquivo de configura√ß√£o 'yt-dlp.conf' criado."
} catch {
    Write-Host "  ‚ùå Falha ao criar o arquivo de configura√ß√£o." -ForegroundColor Red
}

# --- Mensagem Final ---
Write-Host "`n============================================================" -ForegroundColor Green
Write-Host "   üéâ Instala√ß√£o e Configura√ß√£o Conclu√≠das! üéâ" -ForegroundColor White
Write-Host "============================================================" -ForegroundColor Green
Write-Host "\nIMPORTANTE: Voc√™ deve REINICIAR seu terminal (PowerShell, CMD, etc.)" -ForegroundColor Yellow
Write-Host "para que as altera√ß√µes tenham efeito." -ForegroundColor Yellow
